# Spring AOP

## AOP
공통 부가 기능이 생겨나면서 AOP라는 개념이 생겨났다. 이를 알기 위해선 핵심 기능과 부가 기능에 대해 알아야 한다.

### 핵심 기능
- 특정 객체가 제공하는 고유의 기능
- OrderService: 주문 로직
- OrderRepository: 조회, 저장 .. 등

### 부가 기능
- 핵심 기능을 보조하기 위해 제공하는 기능
- 로그 추적 로직
- 트랜잭션

> 부가 기능이 필요하다면 핵심 기능에 추가하면 되지 않나?
> - 로그 추적 로직이 필요한 클래스가 100개이면 100개 모두 공통 로직을 작성해주어야 한다.
> - 핵심 기능과 동떨어진 기능들을 추가해주어야 한다. (SRP 위반)

이러한 공통 부가 기능들을 `횡단 관심사`라고 부른다.

## AOP 소개

### Aspect
- 부가 기능과 부가 기능을 어디에 적용할지 선택하는 기능을 합해서 하나의 모듈로 만들어 놓은 것
- Spring에서 `@Aspect`와 같은 의미
- Spring이 제공하는 Advisor(advice + pointcut)도 개념상 하나의 에스펙트이다.

이렇게 에스펙트를 사용한 프로그래밍 방식을 관점 지향 프로그래밍(AOP)이라 한다.

### AspectJ 프레임워크
- AOP의 대표적인 구현으로 [AspectJ 프레임워크](https://www.eclipse.org/aspectj/) 가 있다.
- 스프링도 AOP를 지원하지만 대부분 AspectJ의 문법을 차용하고, AspectJ가 제공하는 기능의 일부만 제공한다.

## AOP 적용 방식
크게 3가지가 있다.

### 컴파일 시점 - 위빙
- .java 소스 코드를 컴파일러를 사용해 .class를 만드는 시점에 부가 기능 로직을 추가할 수 있다.
- 이땐 AspectJ 가 제공하는 특별한 컴파일러를 사용해야 한다.
- 이렇게 원본 로직에 부가 기능 로직이 추가되는 것을 위빙(Weaving)이라 한다.
- 단점: 특별한 컴파일러가 필요하고 복잡하다.

### 클래스 로딩 시점
- .class 파일은 JVM 내부의 클래스 로더에 보관한다. 이때 중간에서 .class 파일을 조작한 다음 JVM에 올릴 수 있다.
- 자바는 JVM에 저장하기 전에 조작할 수 있는 기능을 제공한다. (java Instrumentation)
  - 수 많은 모니터링 툴들이 이 방식을 사용한다.
- 단점: `java -javaagent` 옵션을 통해 클래스 로도 조작기를 지정해야 하는데, 이 부분이 번거롭고 운영하기 어렵다.

### 런타임 시점 - 위빙
- 자바의 메인 메서드가 실행된 다음이다.
- 자바 언어가 제공하는 범위 안에서 부가 기능을 적용해야 한다.
- 스프링과 같은 컨테이너, 프록시, DI, 빈 포스트 프로세서 같은 개념들을 총 동원해야 한다.
- 스프링 AOP 는 이 방식을 사용한다.

### AOP 적용 위치
- Join point: 생성자, 필드 값 접근, static 메서드 접근, 메서드 실행
- 프록시 방식을 사용하는 스프링 AOP는 메서드 실행 지점에만 AOP를 적용할 수 있다.
  - 프록시는 메서드 오버라이딩 개념으로 동작한다.
  - 프록시를 사용하는 스프링 AOP의 조인 포인트는 메서드 실행으로 제한된다.
  - 스프링 AOP는 스프링 컨테이너가 관리할 수 있는 스프링 빈에만 AOP를 적용할 수 있다.






